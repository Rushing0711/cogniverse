# 第1章 系统安装

## 1  系统安装

本文基于CentOS7最小化安装，主机名`wenqiu`。

### 1.1 分区规划

由于安装目的是学习演练，可能会安装很多软件，保存很多安装包，所以分配300G用来使用（我试过100G不够用的情况），如果是一般性系统安装，分配50G也就够了。分区格式RHEL7开始采用`XSF`格式。

| 挂载点 | 说明                                                         |
| ------ | ------------------------------------------------------------ |
| /boot  | 主分区，存放Linux启动所需的核心文件，推荐大小200M足够，分配1G |
| /      | 逻辑分区，分配50G                                            |
| /home  | 逻辑分区，分配50G                                            |
| swap   | 逻辑分区，虚拟内存，分区格式swap，分配5G                     |
| /var   | 逻辑分区，分配70G                                            |
| /tmp   | 逻辑分区，分配20G                                            |
| /usr   | 逻辑分区，剩下全部空间（大约105G左右）                       |

<span style="color:red;font-weight:bold;">多年使用心得：如果没有特殊需要，建议分3个区（或4个分区，包含/boot/efi分区）即可：</span>

| 挂载点    | 说明                                                         |
| --------- | ------------------------------------------------------------ |
| /boot/efi | 为使用EFI固件的系统设置的特定目录，用于存放EFI启动加载器等内容。分配300MiB |
| /boot     | 存放Linux启动所需的核心文件，推荐大小200M足够。分配1024MiB   |
| swap      | 虚拟内存，分区格式swap，分配大小与内存相关。分配1024MiB      |
| /         | 剩余所有可分配内存，比如100G基本很多场景都够用。             |

其中`swap`分区的大小说明如下：

| 物理内存 | 之前交换分区方案（swap）  | 现在交换分区方案（swwap） |
| :------- | :------------------------ | ------------------------- |
| <=4G     | 至少4G，或者物理内存的2倍 | 4GB                       |
| 4~16G    | 至少8G，或者物理内存的1倍 | 2GB                       |
| 16~64G   | 至少16G                   | 1GB                       |
| 64~256G  | 至少32G                   | 1GB                       |

<span style="color:#1E90FF;font-weight:bold;">来源：Red Hat/Oracle/SUSE等企业发行版的旧文档</span> <span style="color:red;font-weight:bold;">但这些指南在SSD和现代内存管理下已经过时！</span>

### 1.2 MacBook安装配置

- <span style="color:red;font-weight:bold;">概述：4CPU+16G内存+64G硬盘，非必要不使用root用户！！！</span>

- 分区

| 挂载点    | 大小         | 说明                                                         | 设备类型 | 文件系统             |
| --------- | ------------ | ------------------------------------------------------------ | -------- | -------------------- |
| /boot/efi | 300MiB       | 为使用EFI固件的系统设置的特定目录，<br />用于存放EFI启动加载器等内容。分配300MiB | 标准分区 | EFI System Partition |
| /boot     | 1024MiB      | 存放Linux启动所需的核心文件，<br />推荐大小200M足够，分配1024MiB | 标准分区 | xfssss               |
| swap      | 1024MiB      | 虚拟内存，分区格式swap，分配大小与内存相关                   | LVM      | swap                 |
| /         | 剩下全部空间 | 剩下全部空间                                                 | LVM      | Xfs                  |

![image-20260112173828648](images/image-20260112173828648.png)

- 软件
  - 软件选择(S)
    - 最小安装
- 系统
  - 安装目标位置(D)
    - 自定义标准分区
  - KDUMP
    - 已禁用Kdump
  - 网络和主机名(N)
    - 主机名：wenqiu
    - 已连接：enp2s0

- 用户设置
  - ROOT密码(R)：
    - 锁定root账户 ✅
    - 允许root用户使用密码进行SSH登录 ❎
  - 创建用户(U)
    - 全名(F)：emon
    - 用户名(U)：emon
      - 将此用户设为管理员(M) ✅
      - 需要密码才能使用改账户(R) ✅

![image-20260113133342453](images/image-20260113133342453.png)

### 1.3 修改主机名

- 第一步

```bash
$ sudo hostnamectl set-hostname wenqiu
```

- 第二步：验证

```bash
$ sudo cat /etc/hostname
wenqiu
$ sudo hostname
wenqiu
```

- 第三步：配置

```bash
$ sudo vim /etc/hosts
```

```bash
# 这里也可以是某个具体的IP地址
192.168.200.116	wenqiu
```

- 第四部：退出Shell，重新登录即可

## 2 基础配置

### 2.1 配置网络

1. 查看网卡会话

```bash
$ sudo nmcli conn show
```

2. 配置公司网卡会话

```bash
$ sudo nmcli connection add con-name company ifname ens33 autoconnect no type ethernet ip4 10.0.0.116/24 gw4 10.0.0.1
$ sudo nmcli con modify company +ipv4.dns 223.6.6.6
```

3. 配置家庭网卡会话

```bash
$ sudo nmcli connection add con-name house ifname ens33 type ethernet ip4 192.168.1.116/24 gw4 192.168.1.1
$ sudo nmcli con modify house +ipv4.dns 223.6.6.6
```

4. 配置通用net8会话

- 检查net8的网络信息

【VMWare】==>【编辑】==>【虚拟网络编辑器（N）...】==>右下角【更改设置（C）】==>选中【VMnet8】==>【NAT设置（S）...】==>弹出的新窗口，可看到如下信息：

网络：vmnet8

子网IP：192.168.200.0

子网掩码：255.255.255.0

网关IP（G）：192.168.200.2

此时，可配置如下：

```bash
$ sudo nmcli conn add con-name net8 ifname ens33 type ethernet ip4 192.168.200.116/24 gw4 192.168.200.2
# 指定了DNS后，还需要重新激活（nmtui图形界面操作）一下 net8，网络才通
$ sudo nmcli con modify net8 +ipv4.dns 114.114.114.114 223.6.6.6
# 配置开机自动启动该会话
$ sudo nmcli conn mod net8 connection.autoconnect yes 
```

```bash
# 一条命令写完所有配置【推荐】
$ sudo nmcli conn add type ethernet ifname enp2s0 con-name enp2s0 \
    ipv4.addresses 192.168.200.116/24 \
    ipv4.gateway 192.168.200.2 \
    ipv4.dns 192.168.200.2 \
    ipv4.method manual \
    autoconnect yes
```

> 执行： `nmcli conn up net8` 报错如下：
>
> Error: Connection activation failed: No suitable device found for this connection (device lo not available because device is strictly unmanaged).
>
> 解决：
>
> - `nmcli n` 看是不是 disabled
> - 如果是，那么执行 `nmcli n on`

5. 编辑网卡会话

```bash
$ sudo nmtui
```

6. 删除网卡会话

```bash
$ sudo nmcli conn delete company
```

### 2.2 配置虚拟机共享文件夹

- 更新系统包

```bash
$ sudo dnf update -y
```

- 安装`open-vm-tools`

```bash
$ sudo dnf install -y open-vm-tools
```

```bash
# 查看共享文件名称
$ vmware-hgfsclient
```

- 安装桌面增强组件（如果使用图形界面）

```bash
$ sudo dnf install -y open-vm-tools-desktop
```

- 临时挂载共享文件夹（重启失效）

```bash
$ sudo vmhgfs-fuse .host:/ /mnt/hgfs -o subtype=vmhgfs-fuse,allow_other,noatime
```

```bash
# 查看共享文件夹
$ ls /mnt/hgfs
```

- 永久挂载

<span style="color:red;font-weight:bold;">由于/etc/fstab和基于systemd的mount都无效，报错：mount: /mnt/hgfs: 文件系统类型错误、选项错误、.host:/ 上有坏超级块、缺少代码页或帮助程序或其他错误.</span>

<span style="color:#32CD32;font-weight:bold;">这里使用基于systemd的service</span>

```bash
$ sudo tee /etc/systemd/system/hgfs-mount.service <<'EOF'
[Unit]
Description=Mount VMware Shared Folders via vmhgfs-fuse
Documentation=https://github.com/vmware/open-vm-tools
After=vmtoolsd.service
Requires=vmtoolsd.service
ConditionPathIsDirectory=/mnt/hgfs

[Service]
Type=oneshot
RemainAfterExit=yes

# 确保挂载点存在
ExecStartPre=/bin/mkdir -p /mnt/hgfs

# 挂载共享文件夹
ExecStart=/usr/bin/vmhgfs-fuse .host:/ /mnt/hgfs -o subtype=vmhgfs-fuse,allow_other,noatime

# 卸载（用于 systemctl stop 或 shutdown）
ExecStop=/bin/umount /mnt/hgfs

[Install]
WantedBy=multi-user.target
EOF
```

启用服务：

```bash
# 重载 systemd 配置
$ sudo systemctl daemon-reload
# 启用开机自启
$ sudo systemctl enable --now hgfs-mount.service
# 查看共享文件夹
$ ls /mnt/hgfs
```

### 2.3 使用系统镜像文件配置本地yum源

#### 2.3.1 CentOS7

如果本地安装了Git Bash，或者可以使用scp命令，使用scp传输到系统的`/usr/local/src`目录即可。

如果本地没有安装Git Bash，或者无法使用scp命令，可以使用xftp传输到系统的`/usr/local/src`目录。

1. 创建挂载点并挂载

```bash
$ sudo mkdir /mnt/local-repo
$ sudo mount -t iso9660 -o loop /usr/local/src/CentOS-7-x86_64-DVD-2009.iso /mnt/local-repo
```

2. 设置开机自动挂载系统镜像文件

打开文件后，在最后一行追加如下内容：

```bash
$ sudo vi /etc/fstab
# 个人配置
/usr/local/src/CentOS-7-x86_64-DVD-2009.iso /mnt/local-repo        iso9660         defaults,ro,loop 0 0
```

3. 配置本地yum

```bash
$ sudo vi /etc/yum.repos.d/CentOS-7.9.repo
# 如下内容为编辑的文件内容
[CentOS7.9]
name=CentOS7.9
baseurl=file:///mnt/local-repo
enabled=1
gpgcheck=1
gpgkey=file:///mnt/local-repo/RPM-GPG-KEY-CentOS-7
```

4. 更换yum源配置为阿里云源配置

   1. 备份

   ```bash
   $ sudo mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.bak
   ```

   2. 下载新的CentOS-Base.repo到/etc/yum.repos.d/目录

   ```bash
   $ sudo wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo
   ```

   【备注】如果提示无法解析`mirrors.aliyun.com`，应该是当前会话的DNS属于内网IP，只需要再增加`8.8.8.8`这个DNS即可。

5. 查看可用的yum

```bash
$ sudo yum repolist all
```

6. 缓存服务器包信息，之后配合`yum -C search xxx`可用不用联网即可检索软件信息

```bash
# 清理所有旧缓存
$ sudo yum clean all
# 生成新仓库的元数据缓存
$ sudo yum makecache
```

#### 2.3.2 Rocky9

1. 创建挂载点并挂载

```bash
$ sudo mkdir /mnt/local-repo
# 若镜像文件在系统内
$ sudo mount -t iso9660 -o loop /opt/Rocky-9.5-aarch64-dvd.iso /mnt/local-repo
# 若镜像文件在共享文件夹内
$ sudo mount -t iso9660 -o loop /mnt/hgfs/Sharing/Rocky-9.5-aarch64-dvd.iso /mnt/local-repo
```

2. 设置开机自动挂载系统镜像文件

   1. 方案一：挂载本机镜像文件

   ```bash
   $ sudo vi /etc/fstab
   # 个人配置
   /mnt/hgfs/Sharing/Rocky-9.5-aarch64-dvd.iso /mnt/local-repo        iso9660         defaults,ro,loop 0 0
   ```
   
   ```bash
   $ sudo mount -a
   mount: (hint) your fstab has been modified, but systemd still uses
          the old version; use 'systemctl daemon-reload' to reload.
   $ sudo systemctl daemon-reload
   ```
   
   2. 方案二：挂载VMware Fusion共享文件夹下的镜像文件【推荐：减小虚拟机快照大小】
   
   因为 `/mnt/hgfs` 是通过 `hgfs-mount.service` 挂载的，而 ISO 挂载依赖它，所以我们需要一个 **后置服务**。
   
   ```bash
   $ sudo tee /etc/systemd/system/iso-mount.service <<'EOF'
   [Unit]
   Description=Mount Rocky Linux DVD ISO from VMware Shared Folder
   After=hgfs-mount.service
   Requires=hgfs-mount.service
   ConditionPathExists=/mnt/hgfs/Sharing/Rocky-9.5-aarch64-dvd.iso
   
   [Service]
   Type=oneshot
   RemainAfterExit=yes
   ExecStartPre=/bin/mkdir -p /mnt/local-repo
   ExecStart=/bin/mount -o loop,ro /mnt/hgfs/Sharing/Rocky-9.5-aarch64-dvd.iso /mnt/local-repo
   ExecStop=/bin/umount /mnt/local-repo
   
   [Install]
   WantedBy=multi-user.target
   EOF
   ```
   
   启用：
   
   ```bash
   $ sudo systemctl daemon-reload
   $ sudo systemctl enable --now iso-mount.service
   ```
   
3. 配置本地yum

```bash
$ sudo tee /etc/yum.repos.d/Rocky-9.5.repo <<'EOF'
# 如下内容为编辑的文件内容
[Rocky9.5-BaseOS]
name=Rocky9.5-BaseOS
baseurl=file:///mnt/local-repo/BaseOS
enabled=1
gpgcheck=0

[Rocky9.5-AppStream]
name=Rocky9.5-AppStream
baseurl=file:///mnt/local-repo/AppStream
enabled=1
gpgcheck=0
EOF
```

4. 更换yum源配置为阿里云配置

   1. 备份

   ```bash
   $ cd /etc/yum.repos.d/
   [root@wenqiu yum.repos.d]# sudo cp rocky-addons.repo rocky-addons.repo.bak
   [root@wenqiu yum.repos.d]# sudo cp rocky-devel.repo rocky-devel.repo.bak
   [root@wenqiu yum.repos.d]# sudo cp rocky-extras.repo rocky-extras.repo.bak
   [root@wenqiu yum.repos.d]# sudo cp rocky.repo rocky.repo.bak
   [root@wenqiu yum.repos.d]# sudo tar -zcvf Rocky.repo.bak.tar.gz rocky*.bak
   [root@wenqiu yum.repos.d]# sudo rm -rf rocky*.bak
   ```

   2. 执行以下命令替换默认源

   ```bash
   $ sudo sed -e 's|^mirrorlist=|#mirrorlist=|g' \
       -e 's|^#baseurl=http://dl.rockylinux.org/$contentdir|baseurl=https://mirrors.aliyun.com/rockylinux|g' \
       -i.bak \
       /etc/yum.repos.d/rocky*.repo
   ```

   3. 删除sed产生的备份文件

   ```bash
   $ sudo rm -rf rocky*.bak
   ```

5. 查看可用的yum

```bash
$ sudo dnf repolist all
```

6. 缓存服务器包信息，之后配合`yum -C search xxx`可用不用联网即可检索软件信息

```bash
# 清理所有旧缓存
$ sudo dnf clean all
# 生成新仓库的元数据缓存
$ sudo dnf makecache
```

### 2.4 创建具有sudo权限的普通用户

0. 测试是否可以使用sudo

```bash
# 输出root表示可以；xxx is not in the sudoers file. This incident will be reported. 表示不可以
$ sudo whoami
```

1. 创建普通用户

```bash
$ sudo useradd -c "Web Site User" emon
```

2. 修改密码

```bash
$ sudo passwd emon
```

3. 赋权sudo

   1. 方案一：配置`visudo`

   root用户以`visudo`命令打开文件，找到`## Allow root to run any commands anywhere`，在之后追加：

   ```bash
   $ sudo visudo
   ## Allow root to run any commands anywhere
   root    ALL=(ALL)       ALL
   emon    ALL=(ALL)       ALL
   ```

   2. 方案二：添加到wheel组

   Rocky Linux 默认启用了一个非常方便的机制：

   > **任何属于 `wheel` 组的用户，都可以使用 `sudo`**
   >
   > 这是由 `/etc/sudoer` 文件中的配置启用的。
   >
   > ```bash
   > ## Allows people in group wheel to run all commands
   > %wheel  ALL=(ALL)       ALL
   > ```

   所以，最简单的方法不是改 sudoers，而是：

   ```bash
   # 将用户加入 wheel 组
   sudo usermod -aG wheel 你的用户名
   ```

### 2.5 安装常用命令

安装之前，请先使用`whereis <cmd>`命令或者`yum list <cmd>`命令进行检查，是否已经安装。

| 安装命令（精简）                                          | 作用说明                                              |
| --------------------------------------------------------- | ----------------------------------------------------- |
| `vim git curl wget bash-completion tree unzip tar psmisc` | 基础编辑、版本控制、下载、Shell 增强与文件归档工具    |
| `tmux rsync lsof`                                         | 终端复用、高效文件同步、查看进程打开的文件            |
| `net-tools iproute bind-utils socat nmap-ncat ethtool`    | 网络诊断（ifconfig/ip）、DNS 查询、端口转发、链路检测 |
| `conntrack-tools ipset ebtables nftables`                 | 高级防火墙与连接跟踪（K8s/容器网络常用）              |
| `chrony policycoreutils-python-utils`                     | 时间同步、容器运行时、SELinux 策略管理                |
| `htop glances ncdu iotop iftop sysstat smartmontools`     | 系统实时监控（CPU/内存/磁盘/IO/网络/硬盘健康）        |
| `tcpdump nmap mtr iperf3`                                 | 网络抓包、端口扫描、路由追踪、带宽测试                |
| `gcc make jq strace`                                      | 编译构建、JSON 处理、系统调用调试                     |
| `p7zip unrar fio parted gdisk`                            | 解压多种格式、磁盘性能测试、分区管理（MBR/GPT）       |

```bash
# 安装前，查看已启用（开机自启）的服务
$ systemctl list-unit-files --type=service --state=enabled
```

```bash
# 启用 EPEL 第三方软件仓库
sudo dnf install -y epel-release
# 清理旧元数据并重建新仓库缓存（确保 EPEL 包可被发现）
sudo dnf clean all && sudo dnf makecache
# 安装编辑器、Shell 增强与基础工具
sudo dnf install -y vim git curl wget bash-completion tree unzip tar psmisc
# 安装终端复用、文件同步与进程/文件查看工具
sudo dnf install -y tmux rsync lsof
# 安装基础网络诊断与配置工具（含传统与现代命令）
sudo dnf install -y net-tools iproute bind-utils socat nmap-ncat ethtool
# 安装防火墙、连接跟踪与网络策略管理工具
sudo dnf install -y conntrack-tools ipset ebtables nftables
# 安装时间同步、容器运行时与 SELinux 管理工具
sudo dnf install -y chrony policycoreutils-python-utils
# 安装系统资源实时监控工具（CPU/内存/磁盘/IO/网络）
sudo dnf install -y htop glances ncdu iotop iftop sysstat smartmontools
# 安装网络抓包、扫描、路由追踪与带宽测试工具
sudo dnf install -y tcpdump nmap mtr iperf3
# 安装开发编译与系统调试工具
sudo dnf install -y gcc make jq strace
# 安装压缩解压、磁盘性能测试与分区管理工具
sudo dnf install -y p7zip unrar fio parted gdisk

# === 清理 swap（通用且安全）===
if swapon --show > /dev/null 2>&1; then
    sudo swapoff -a
    sudo sed -i '/^[^#].*swap/s/^/#/' /etc/fstab
    while IFS= read -r line; do
        NAME=$(echo "$line" | awk '{print $1}')
        TYPE=$(echo "$line" | awk '{print $2}')
        if [ "$TYPE" = "partition" ]; then
            sudo dd if=/dev/zero of="$NAME" bs=1M status=progress 2>/dev/null
        elif [ "$TYPE" = "file" ]; then
            sudo rm -f "$NAME"
        fi
		done < <(swapon --show=NAME,TYPE --noheadings)
fi

# === 清理其他缓存 ===
sudo dnf clean all # 清理 DNF/YUM 所有缓存（减少镜像体积）
sudo rm -rf /var/log/dnf.* /var/log/yum.* # 删除 DNF/YUM 安装日志
sudo journalctl --vacuum-time=1s 2>/dev/null || true # 清空 systemd 日志（保留最近1秒，实际清空全部）
sudo rm -f /var/log/journal/*/*.journal~ 2>/dev/null || true # 删除残留的 journal 日志备份文件
sudo rm -rf /tmp/* /var/tmp/* # 清空临时目录
sudo restorecon -R /tmp /var/tmp /var/log 2>/dev/null || true  # 修复 SELinux 上下文

# === 安全归零主文件系统空闲空间 ===
FREE_SPACE=$(df / | awk 'NR==2 {print $4}')
FREE_MB=$((FREE_SPACE / 1024))
WRITE_MB=$((FREE_MB * 95 / 100))
[ $WRITE_MB -gt 4096 ] && WRITE_MB=4096
[ $WRITE_MB -gt 0 ] && {
		# 归零磁盘空闲空间（关键！便于 VMware 精简磁盘）
    sudo dd if=/dev/zero of=/EMPTY bs=1M count=$WRITE_MB status=progress 2>/dev/null
    sudo sync # 确保数据真正写入磁盘再删除
    sudo rm -f /EMPTY # 删除归零文件
}
```

```bash
# 安装后，查看已启用（开机自启）的服务
$ systemctl list-unit-files --type=service --state=enabled
```

::: details 各命令/包功能简述

当然可以！以下是对你脚本中 **每个软件包** 的**逐项详细说明**，按安装顺序分组，清晰列出其核心用途，便于你理解为何需要它。

------

**📦 第一组：基础工具**

| 软件包            | 详细用途                                                     |
| :---------------- | :----------------------------------------------------------- |
| `vim`             | 强大的命令行文本编辑器（比 vi 功能更丰富）                   |
| `git`             | 分布式版本控制系统，用于代码/配置管理                        |
| `curl`            | 传输数据的命令行工具（支持 HTTP/HTTPS/FTP 等，常用于 API 调用） |
| `wget`            | 从网络下载文件（支持断点续传，适合批量下载）                 |
| `bash-completion` | 为 Bash 提供智能 Tab 补全（如命令、选项、文件名自动补全）    |
| `tree`            | 以树状图形式列出目录结构，便于查看文件层级                   |
| `unzip`           | 解压 `.zip` 格式的压缩文件                                   |
| `tar`             | 打包和解包 `.tar`、`.tar.gz`、`.tar.xz` 等归档文件（Linux 最常用） |
| `psmisc`          | 包含 `pstree`（进程树）、`killall`（按名称杀进程）等实用工具 |

------

**📦 第二组：终端与文件同步**
| 软件包  | 详细用途                                                     |
| :------ | :----------------------------------------------------------- |
| `tmux`  | 终端复用器：可创建会话、分屏、后台运行任务（SSH 断连不中断） |
| `rsync` | 高效同步文件/目录（增量传输，常用于备份或部署）              |
| `lsof`  | 列出打开的文件（包括网络连接、设备、普通文件），排查“文件被占用”问题 |

------

**📦 第三组：网络诊断（传统 + 现代）**

| 软件包       | 详细用途                                                     |
| :----------- | :----------------------------------------------------------- |
| `net-tools`  | 传统网络工具包：包含 `ifconfig`, `netstat`, `route`（已逐步被 `ip` 替代，但兼容旧脚本） |
| `iproute`    | 现代网络工具包：提供 `ip`（替代 ifconfig/route）、`ss`（替代 netstat）等 |
| `bind-utils` | DNS 查询工具：`nslookup`, `dig`, `host`（排查域名解析问题）  |
| `socat`      | “网络瑞士军刀”：双向数据转发（TCP/UDP/Unix socket 等），比 `nc` 更强大 |
| `nmap-ncat`  | `ncat` 是 Nmap 项目下的增强版 `netcat`，用于端口扫描、监听、代理等 |
| `ethtool`    | 查看/配置网卡参数（如速率、双工、驱动信息）                  |

------

**📦 第四组：防火墙与网络策略**

| 软件包            | 详细用途                                                     |
| :---------------- | :----------------------------------------------------------- |
| `conntrack-tools` | 管理内核连接跟踪表（`conntrack` 命令），常用于排查 NAT 或容器网络问题 |
| `ipset`           | 高效 IP 地址集合管理（配合 iptables/nftables 实现大批量 IP 规则） |
| `ebtables`        | 管理以太网桥接层的过滤规则（用于虚拟化/容器网络底层控制）    |
| `nftables`        | 新一代 Linux 包过滤框架（替代 iptables），语法更简洁、性能更高 |

------

**📦 第五组：系统服务与安全**

| 软件包                         | 详细用途                                                     |
| :----------------------------- | :----------------------------------------------------------- |
| `chrony`                       | 高精度时间同步服务（比 ntpd 更适合虚拟机和间歇性联网环境）   |
| `policycoreutils-python-utils` | SELinux 管理工具（包含 `semanage`，用于修改文件/端口安全上下文） |

------

**📦 第六组：系统监控**

| 软件包                                                       | 详细用途                                                     |
| :----------------------------------------------------------- | :----------------------------------------------------------- |
| `htop`                                                       | 交互式进程查看器（比 top 更直观，支持鼠标、颜色、树状视图）  |
| `glances`                                                    | 全能系统监控工具（CPU/内存/磁盘/网络/进程/传感器等一体化展示） |
| `ncdu`                                                       | 磁盘使用分析器（交互式查看大文件/目录，类似 `du -sh *` 的升级版） |
| `iotop`                                                      | 实时监控磁盘 I/O 使用情况（找出高 IO 进程）                  |
| `iftop`                                                      | 实时监控网络带宽使用（按连接显示流量，类似 top for network） |
| <span style="color:#32CD32;font-weight:bold;">`sysstat`</span> | 包含 `sar`、`iostat`、`mpstat` 等，用于历史性能数据采集与分析（会增加sysstat.service服务） |
| <span style="color:#32CD32;font-weight:bold;">`smartmontools`</span> | 读取硬盘 SMART 信息（预测磁盘故障，检查健康状态）            |

------

📦 第七组：网络测试

| 软件包    | 详细用途                                                     |
| :-------- | :----------------------------------------------------------- |
| `tcpdump` | 抓取网络数据包（用于深度分析协议、排查连接问题）             |
| `nmap`    | 网络发现与安全扫描工具（主机发现、端口扫描、服务识别）       |
| `mtr`     | 结合 `ping` 和 `traceroute` 的网络诊断工具（实时显示路由路径和延迟） |
| `iperf3`  | 网络带宽性能测试（测量 TCP/UDP 吞吐量，验证链路质量）        |

------

📦 第八组：开发与调试

| 软件包   | 详细用途                                                    |
| :------- | :---------------------------------------------------------- |
| `gcc`    | GNU C/C++ 编译器（编译源码、安装某些 Python/Ruby 扩展必需） |
| `make`   | 自动化构建工具（根据 Makefile 编译项目）                    |
| `jq`     | 命令行 JSON 处理器（解析、过滤、格式化 JSON，脚本中极常用） |
| `strace` | 跟踪进程的系统调用和信号（调试程序崩溃、权限问题等）        |

------

**📦 第九组：存储与分区**

| 软件包   | 详细用途                                                     |
| :------- | :----------------------------------------------------------- |
| `p7zip`  | 支持 `.7z` 格式的高压缩率解压工具                            |
| `unrar`  | 解压 `.rar` 格式文件（常见于 Windows 共享文件）              |
| `fio`    | 灵活的磁盘 I/O 性能测试工具（模拟随机/顺序读写，评估存储性能） |
| `parted` | 命令行分区工具（支持大于 2TB 的磁盘，操作 MBR 分区表）       |
| `gdisk`  | GPT 分区表专用工具（用于 UEFI 系统的大容量磁盘分区）         |

------

✅ **总结**：
软件包覆盖了 **运维、开发、网络、安全、监控、存储** 六大核心场景，**无冗余、无 GUI 依赖**，非常适合构建一个**轻量但功能完备**的 Linux 基础镜像。

:::

### 2.6 修改vim的缩进为4个空格

打开文件后，在最后一行追加如下内容：

```bash
$ sudo tee -a /etc/vimrc  <<'EOF'
" 个人配置
set tabstop=4
set softtabstop=4
set shiftwidth=4
set expandtab
" 如下设置，在vim的插入模式下，点击F9可以进入“插入(粘贴)”模式，再执行粘贴时不会混乱格式；再次点击F9退出“插入(粘贴)”模式。
set pastetoggle=<F9>
EOF
```

### 2.7 配置DNS解析（配置网络后，这里已经正常）

#### 2.7.1 配置本地DNS解析

打开文件后，在最后一行追加如下内容：

```bash
$ sudo vim /etc/hosts
```

```bash
192.168.200.116   wenqiu
```

#### 2.7.2 配置公网DNS解析

```bash
$ sudo vim /etc/resolv.conf
```

```bash
# 主DNS：VMware网关（继承宿主机设置）
nameserver 192.168.200.2

# 备用DNS：公共DNS（防止网关故障）
nameserver 114.114.114.114
nameserver 8.8.8.8
```

- 两种配置的对比分析

| **配置方案**                 | 优点                                                         | 缺点                                                     | 适用场景                   |
| :--------------------------- | :----------------------------------------------------------- | :------------------------------------------------------- | :------------------------- |
| `nameserver 192.168.200.2`   | 1. 自动继承宿主机 DNS 设置 2. 支持内网域名解析 3. 可访问宿主机 VPN 的内部资源 | 依赖 VMware NAT 服务的稳定性                             | **推荐作为首选方案**       |
| `nameserver 114.114.114.114` | 1. 不依赖宿主机网络 2. 直接公网解析                          | 1. 无法解析内网资源 2. 宿主机 VPN 失效时无法访问内部系统 | 宿主机网络异常时的备用方案 |

- 为什么 `192.168.200.2` 更合适？

```mermaid
graph LR
    A[虚拟机] --> B[VMnet8网关 192.168.200.2]
    B --> C[宿主机 192.168.200.1]
    C --> D[物理路由器]
    D --> E[互联网]
```

### 2.8 配置服务器时区

- 查询服务器时区

```bash
$ timedatectl
               Local time: 五 2025-07-11 10:22:14 CST
           Universal time: 五 2025-07-11 02:22:14 UTC
                 RTC time: 五 2025-07-11 02:22:15
                Time zone: Asia/Shanghai (CST, +0800)
System clock synchronized: yes
              NTP service: active
          RTC in local TZ: no
```

- 配置服务器时区为 **Asia/Shanghai**。

```bash
$ timedatectl set-timezone Asia/Shanghai
```

### 2.9 Rocky9时间同步问题（针对虚拟机场景）

<span style="color:red;font-weight:bold;">Rocky Linux 9 默认使用 `chrony` 作为 NTP 客户端，若发现恢复快照后，或MacOS恢复工作状态后，虚拟机系统时钟不同步，表现为：</span>

```bash {6}
$ timedatectl 
               Local time: 四 2025-05-29 15:00:27 CST
           Universal time: 四 2025-05-29 07:00:27 UTC
                 RTC time: 五 2025-05-30 22:36:01
                Time zone: Asia/Shanghai (CST, +0800)
System clock synchronized: no
              NTP service: active
          RTC in local TZ: no
```

`timedatectl` 显示 `System clock synchronized: no`，即使 NTP 服务是 active 状态。这是因为恢复快照后时间偏差太大，chronyd 服务不会自动大幅调整时间（出于安全考虑）。

- 启用并启动服务

```bash
$ sudo systemctl enable --now vmtoolsd
```

[配置时间同步](http://localhost:8751/devops/new/Linux/05-%E7%AC%AC5%E7%AB%A0%20%E5%AE%9E%E7%94%A8%E6%8C%87%E4%BB%A4.html#_4-4-%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5%E6%9C%8D%E5%8A%A1)

## 3 一些说明

关于软件端口访问，如果防火墙开启(`systemctl start firewalld`)，且需要外部环境访问，那么可以开放端口(`firewalld-cmd`命令)，如果不需要外部访问，只需要在本机内访问，通过`127.0.0.1`方式访问即可。如果防火墙关闭(`systemctl stop firewalld`)，那么外部与本机都可以直接通过IP地址访问。

在本文以下的安装中，默认是防火墙开启状态，且需要外部通过IP地址访问的，所以需要开放端口的软件，会开放端口。比如vsftpd的21端口，Nginx的80端口等等。
